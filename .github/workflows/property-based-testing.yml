name: Property-Based Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly for extended property testing
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      test_iterations:
        description: 'Number of test iterations'
        required: false
        default: '1000'
        type: string

env:
  NODE_VERSION: '18'
  POSTGRES_VERSION: '15'
  REDIS_VERSION: '7'
  ELASTICSEARCH_VERSION: '8.11.0'

jobs:
  # Property-Based Testing
  property-tests:
    name: Property-Based Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_DB: opportunex_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:${{ env.REDIS_VERSION }}-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:${{ env.ELASTICSEARCH_VERSION }}
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
        ports:
          - 9200:9200

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/opportunex_test
      REDIS_URL: redis://localhost:6379
      ELASTICSEARCH_URL: http://localhost:9200
      NODE_ENV: test
      JWT_SECRET: test-jwt-secret-key-for-pbt
      REFRESH_TOKEN_SECRET: test-refresh-token-secret-for-pbt
      PBT_ITERATIONS: ${{ github.event.inputs.test_iterations || '100' }}

    strategy:
      matrix:
        property-group:
          - search-and-filtering
          - user-management
          - data-aggregation
          - ai-instructor
          - notifications

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for services
        run: |
          # Wait for PostgreSQL
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          
          # Wait for Redis
          until redis-cli -h localhost -p 6379 ping; do
            echo "Waiting for Redis..."
            sleep 2
          done
          
          # Wait for Elasticsearch
          until curl -f http://localhost:9200/_cluster/health; do
            echo "Waiting for Elasticsearch..."
            sleep 5
          done

      - name: Setup test environment
        run: |
          npm run db:generate
          npm run db:migrate
          npm run env:validate

      - name: Run Property-Based Tests - Search and Filtering
        if: matrix.property-group == 'search-and-filtering'
        run: |
          echo "ðŸ§ª Running Search and Filtering Property Tests..."
          # Property 1: Comprehensive Search Relevance
          npm run test:property -- --grep "Property 1.*Comprehensive Search Relevance"
          
          # Property 2: Filter Combination Correctness
          npm run test:property -- --grep "Property 2.*Filter Combination Correctness"
          
          # Property 3: Voice Processing Pipeline
          npm run test:property -- --grep "Property 3.*Voice Processing Pipeline"
          
          # Property 14: Contextual Query Handling
          npm run test:property -- --grep "Property 14.*Contextual Query Handling"

      - name: Run Property-Based Tests - User Management
        if: matrix.property-group == 'user-management'
        run: |
          echo "ðŸ§ª Running User Management Property Tests..."
          # Property 9: Profile-Based Personalization
          npm run test:property -- --grep "Property 9.*Profile-Based Personalization"
          
          # Property 10: Profile Update Propagation
          npm run test:property -- --grep "Property 10.*Profile Update Propagation"

      - name: Run Property-Based Tests - Data Aggregation
        if: matrix.property-group == 'data-aggregation'
        run: |
          echo "ðŸ§ª Running Data Aggregation Property Tests..."
          # Property 4: Opportunity Display Completeness
          npm run test:property -- --grep "Property 4.*Opportunity Display Completeness"
          
          # Property 5: Data Source Aggregation
          npm run test:property -- --grep "Property 5.*Data Source Aggregation"
          
          # Property 6: Duplicate Detection and Merging
          npm run test:property -- --grep "Property 6.*Duplicate Detection and Merging"
          
          # Property 12: External Link Integrity
          npm run test:property -- --grep "Property 12.*External Link Integrity"
          
          # Property 15: Quality Control and Fraud Detection
          npm run test:property -- --grep "Property 15.*Quality Control and Fraud Detection"

      - name: Run Property-Based Tests - AI Instructor
        if: matrix.property-group == 'ai-instructor'
        run: |
          echo "ðŸ§ª Running AI Instructor Property Tests..."
          # Property 7: AI Roadmap Generation
          npm run test:property -- --grep "Property 7.*AI Roadmap Generation"
          
          # Property 8: Personalized Roadmap Adaptation
          npm run test:property -- --grep "Property 8.*Personalized Roadmap Adaptation"

      - name: Run Property-Based Tests - Notifications
        if: matrix.property-group == 'notifications'
        run: |
          echo "ðŸ§ª Running Notifications Property Tests..."
          # Property 11: Notification Matching and Preferences
          npm run test:property -- --grep "Property 11.*Notification Matching and Preferences"
          
          # Property 13: Error Handling for Voice Input
          npm run test:property -- --grep "Property 13.*Error Handling for Voice Input"

      - name: Generate Property Test Report
        if: always()
        run: |
          echo "ðŸ“Š Property Test Results for ${{ matrix.property-group }}"
          # Generate detailed report of property test results
          # This would typically parse test output and create summaries

      - name: Upload Property Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: property-test-results-${{ matrix.property-group }}
          path: |
            test-results/
            coverage/
          retention-days: 7

  # Extended Property Testing (Nightly)
  extended-property-tests:
    name: Extended Property Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    timeout-minutes: 60
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_DB: opportunex_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:${{ env.REDIS_VERSION }}-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:${{ env.ELASTICSEARCH_VERSION }}
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms1g -Xmx1g
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
        ports:
          - 9200:9200

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/opportunex_test
      REDIS_URL: redis://localhost:6379
      ELASTICSEARCH_URL: http://localhost:9200
      NODE_ENV: test
      JWT_SECRET: test-jwt-secret-key-for-extended-pbt
      REFRESH_TOKEN_SECRET: test-refresh-token-secret-for-extended-pbt
      PBT_ITERATIONS: '10000'  # Extended testing with more iterations

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for services
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do sleep 2; done
          until redis-cli -h localhost -p 6379 ping; do sleep 2; done
          until curl -f http://localhost:9200/_cluster/health; do sleep 5; done

      - name: Setup test environment
        run: |
          npm run db:generate
          npm run db:migrate
          npm run env:validate

      - name: Run Extended Property Tests
        run: |
          echo "ðŸ§ª Running Extended Property-Based Tests (10,000 iterations)..."
          npm run test:property:extended

      - name: Generate Extended Test Report
        if: always()
        run: |
          echo "ðŸ“Š Extended Property Test Results"
          echo "Total iterations: 10,000 per property"
          echo "Test duration: $(date)"
          # Generate comprehensive report

      - name: Upload Extended Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: extended-property-test-results
          path: |
            test-results/
            coverage/
            performance-metrics/
          retention-days: 30

  # Property Test Analysis
  analyze-property-results:
    name: Analyze Property Test Results
    runs-on: ubuntu-latest
    needs: [property-tests]
    if: always()
    
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: property-test-results-*
          merge-multiple: true

      - name: Analyze test results
        run: |
          echo "ðŸ“Š Property-Based Testing Analysis"
          echo "================================="
          
          # Analyze results from all property groups
          for group in search-and-filtering user-management data-aggregation ai-instructor notifications; do
            echo "Group: $group"
            if [ -d "property-test-results-$group" ]; then
              echo "âœ… Tests completed"
              # Add analysis logic here
            else
              echo "âŒ Tests failed or incomplete"
            fi
            echo ""
          done

      - name: Create summary report
        run: |
          echo "# Property-Based Testing Summary" > property-test-summary.md
          echo "" >> property-test-summary.md
          echo "## Test Execution" >> property-test-summary.md
          echo "- Date: $(date)" >> property-test-summary.md
          echo "- Commit: ${{ github.sha }}" >> property-test-summary.md
          echo "- Branch: ${{ github.ref_name }}" >> property-test-summary.md
          echo "" >> property-test-summary.md
          echo "## Results" >> property-test-summary.md
          # Add detailed results analysis

      - name: Upload summary report
        uses: actions/upload-artifact@v6
        with:
          name: property-test-summary
          path: property-test-summary.md